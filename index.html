<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mid-PI Review</title>
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-card: #ffffff;
            --bg-header: #1e293b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #ffffff;
            --border: #e2e8f0;
            --accent-blue: #3b82f6;
            --status-done: #22c55e;
            --status-progress: #3b82f6;
            --status-todo: #e2e8f0;
            --indicator-green: #22c55e;
            --indicator-orange: #f59e0b;
            --indicator-red: #ef4444;
            --info-bg: #e0f2fe;
            --info-border: #7dd3fc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        h1 { font-size: 1.75rem; font-weight: 600; }

        .help-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .help-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

        .subtitle { color: var(--text-secondary); margin-bottom: 2rem; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
        }
        .modal h2 { font-size: 1.25rem; margin-bottom: 1.5rem; }
        .modal h3 { font-size: 1rem; margin: 1.5rem 0 0.75rem; color: var(--text-primary); }
        .modal p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .modal-close {
            float: right;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .modal-close:hover { color: var(--text-primary); }

        .rule-table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; font-size: 0.85rem; }
        .rule-table th, .rule-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); }
        .rule-table th { background: var(--bg-primary); font-weight: 500; }

        .indicator-inline { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 0.5rem; }
        .indicator-inline.red { background: var(--indicator-red); }
        .indicator-inline.orange { background: var(--indicator-orange); }
        .indicator-inline.green { background: var(--indicator-green); }

        /* Upload zone */
        .upload-zone {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-zone:hover { border-color: var(--accent-blue); background: #f1f5f9; }
        .upload-zone.dragover { border-color: var(--accent-blue); background: #eff6ff; }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }
        .upload-text { color: var(--text-secondary); }
        .upload-text strong { color: var(--accent-blue); }

        /* Info box */
        .info-box {
            background: var(--info-bg);
            border-left: 4px solid var(--info-border);
            border-radius: 0 8px 8px 0;
            padding: 1rem 1.25rem;
            margin-bottom: 2rem;
        }
        .info-box-title { font-weight: 600; margin-bottom: 0.25rem; }
        .info-box-content { color: var(--text-secondary); font-size: 0.9rem; }

        /* Navigation tabs */
        .nav-tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .nav-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .nav-tab:hover { border-color: var(--accent-blue); }
        .nav-tab.active { background: var(--bg-header); color: var(--text-light); border-color: var(--bg-header); }
        .nav-tab .alert-badge { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 0.5rem; }
        .nav-tab .alert-badge.red { background: var(--indicator-red); }
        .nav-tab .alert-badge.orange { background: var(--indicator-orange); }
        .nav-tab .alert-badge.green { background: var(--indicator-green); }

        /* Team section */
        .team-section { display: none; }
        .team-section.active { display: block; }
        .team-header { background: var(--info-bg); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem; }
        .team-name { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .team-meta { color: var(--text-secondary); font-size: 0.9rem; }
        .team-metrics { display: flex; gap: 1.5rem; margin-top: 0.75rem; font-size: 0.85rem; flex-wrap: wrap; }
        .team-metric { display: flex; align-items: center; gap: 0.5rem; }
        .team-metric-value { font-weight: 600; }

        /* Summary cards */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .summary-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; text-align: center; }
        .summary-card-value { font-size: 1.75rem; font-weight: 700; }
        .summary-card-label { color: var(--text-secondary); font-size: 0.85rem; }
        .summary-card.done .summary-card-value { color: var(--status-done); }
        .summary-card.progress .summary-card-value { color: var(--status-progress); }

        /* Epics table */
        .epics-section h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; }
        .epics-table { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .epics-table-header {
            display: grid;
            grid-template-columns: 90px 1fr 100px 150px 120px 50px;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-header);
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
        }
        .epic-row {
            display: grid;
            grid-template-columns: 90px 1fr 100px 150px 120px 50px;
            gap: 0.75rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .epic-row:last-child { border-bottom: none; }
        .epic-row.highlight { background: #fef2f2; }
        .epic-key { font-family: 'SF Mono', Monaco, monospace; font-size: 0.85rem; color: var(--text-secondary); }
        .epic-title { font-size: 0.9rem; }

        /* Type badge */
        .type-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        .type-badge.build { background: #dbeafe; color: #1d4ed8; }
        .type-badge.run { background: #fef3c7; color: #b45309; }

        /* Composant text */
        .composant-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Status badge */
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .status-badge.en-cours { background: #dbeafe; color: #1d4ed8; }
        .status-badge.a-faire { background: #f1f5f9; color: #475569; }
        .status-badge.a-cadrer { background: #fef3c7; color: #b45309; }
        .status-badge.termine { background: #dcfce7; color: #166534; }
        .status-badge.backlog { background: #f1f5f9; color: #475569; }

        /* Progress bar */
        .progress-cell { display: flex; flex-direction: column; gap: 0.25rem; }
        .progress-text { font-size: 0.85rem; }
        .progress-bar { height: 6px; background: var(--status-todo); border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }
        .progress-bar-fill.green { background: var(--indicator-green); }
        .progress-bar-fill.orange { background: var(--indicator-orange); }
        .progress-bar-fill.red { background: var(--indicator-red); }
        .progress-bar-fill.gray { background: #94a3b8; }

        /* Indicator */
        .indicator { width: 12px; height: 12px; border-radius: 50%; margin: 0 auto; }
        .indicator.green { background: var(--indicator-green); }
        .indicator.orange { background: var(--indicator-orange); }
        .indicator.red { background: var(--indicator-red); }
        .indicator.none { background: transparent; border: 2px solid var(--border); }

        /* Global view */
        .global-table { width: 100%; border-collapse: collapse; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .global-table th, .global-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        .global-table th { background: var(--bg-header); color: var(--text-light); font-weight: 500; font-size: 0.85rem; }
        .global-table tr:last-child td { border-bottom: none; }
        .global-table td { font-size: 0.9rem; }

        .hidden { display: none !important; }

        @media print {
            .upload-zone, .nav-tabs, .help-btn { display: none; }
            .team-section { display: block !important; page-break-after: always; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Mid-PI Review</h1>
            <button class="help-btn" id="helpBtn">Voir les regles</button>
        </div>
        <p class="subtitle">Dashboard d'avancement des Epics</p>

        <!-- Modal -->
        <div class="modal-overlay" id="modalOverlay">
            <div class="modal">
                <button class="modal-close" id="modalClose">&times;</button>
                <h2>Regles d'analyse</h2>

                <h3>Indicateur equipe</h3>
                <p>Alerte sur le risque de ne pas tout livrer d'ici la fin du quarter.</p>
                <table class="rule-table">
                    <tr><th>Indicateur</th><th>Signification</th></tr>
                    <tr><td><span class="indicator-inline red"></span>Rouge</td><td><strong>Risque eleve</strong> — Action corrective necessaire.</td></tr>
                    <tr><td><span class="indicator-inline orange"></span>Orange</td><td><strong>Attention</strong> — A surveiller.</td></tr>
                    <tr><td><span class="indicator-inline green"></span>Vert</td><td><strong>En bonne voie</strong> — Rythme attendu.</td></tr>
                </table>

                <h3>Ce qui declenche une alerte</h3>
                <p><strong>Dispersion sans livraison</strong> — Plus de 80% des epics en cours mais aucune terminee</p>
                <p><strong>Scope mal defini</strong> — Plus de 40% des epics encore "A cadrer" a mi-PI</p>
                <p><strong>Peu de livraison</strong> — Moins de 10% des epics terminees</p>
                <p><strong>Trop d'Epics en attente</strong> — Plus de 40% des epics non demarrees</p>

                <h3>Pourquoi les statuts Epic plutot que les tickets ?</h3>
                <p>Sur du <strong>Build</strong>, le scope devrait etre stable mais evolue souvent (decouverte, ajustements). Un % tickets done peut baisser meme si on avance.</p>
                <p>Sur du <strong>Run</strong>, c'est du flux continu — le scope n'est jamais fige, les % tickets n'ont pas de sens.</p>

                <h3>Points d'attention Epic</h3>
                <table class="rule-table">
                    <tr><th>Situation</th><th>Probleme</th></tr>
                    <tr><td>En cours mais peu avancee</td><td>Demarree mais bloquee</td></tr>
                    <tr><td>A cadrer avec des tickets</td><td>Travail commence sans cadrage</td></tr>
                    <tr><td>Backlog mais bien avancee</td><td>Statut a mettre a jour</td></tr>
                </table>
            </div>
        </div>

        <!-- Upload zone -->
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">+</div>
            <input type="file" id="csvInput" accept=".csv">
            <p class="upload-text"><strong>Cliquer pour charger</strong> ou glisser-deposer le fichier CSV</p>
        </div>

        <!-- Info box -->
        <div class="info-box hidden" id="infoBox">
            <div class="info-box-title">Extraction chargee</div>
            <div class="info-box-content" id="extractionInfo"></div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs hidden" id="navTabs"></div>

        <!-- Content -->
        <div id="content"></div>
    </div>

    <script>
        // State
        let data = [];
        let teams = [];
        let products = [];
        let teamFilters = {};

        // DOM elements
        const uploadZone = document.getElementById('uploadZone');
        const csvInput = document.getElementById('csvInput');
        const infoBox = document.getElementById('infoBox');
        const extractionInfo = document.getElementById('extractionInfo');
        const navTabs = document.getElementById('navTabs');
        const content = document.getElementById('content');
        const modalOverlay = document.getElementById('modalOverlay');
        const helpBtn = document.getElementById('helpBtn');
        const modalClose = document.getElementById('modalClose');

        // Modal
        helpBtn.addEventListener('click', () => modalOverlay.classList.add('active'));
        modalClose.addEventListener('click', () => modalOverlay.classList.remove('active'));
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.classList.remove('active'); });

        // Upload
        uploadZone.addEventListener('click', () => csvInput.click());
        csvInput.addEventListener('change', (e) => { if (e.target.files[0]) processFile(e.target.files[0]); });
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.name.endsWith('.csv')) processFile(e.dataTransfer.files[0]);
        });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => { parseCSV(e.target.result); render(); };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';').map(v => v.trim());
                if (values.length >= 6) {
                    data.push({
                        equipe: values[0],
                        epic: values[1],
                        titre: values[2],
                        statut: values[3],
                        total: parseInt(values[4]) || 0,
                        done: parseInt(values[5]) || 0,
                        enCours: parseInt(values[6]) || 0,
                        type: values[7] || '',
                        composant: values[8] || ''
                    });
                }
            }
            teams = [...new Set(data.map(d => d.equipe))];
            products = [...new Set(data.filter(d => d.composant).map(d => d.composant))].sort();
        }

        function categorizeStatus(statut) {
            const s = statut.toLowerCase();
            if (s.includes('termin')) return 'termine';
            if (s.includes('cours')) return 'enCours';
            if (s.includes('cadrer')) return 'aCadrer';
            return 'aFaire';
        }

        function getStatusClass(statut) {
            const s = statut.toLowerCase();
            if (s.includes('cours')) return 'en-cours';
            if (s.includes('cadrer')) return 'a-cadrer';
            if (s.includes('termin')) return 'termine';
            return 'a-faire';
        }

        function getTeamMetrics(teamData) {
            const totalEpics = teamData.length;
            const termine = teamData.filter(d => categorizeStatus(d.statut) === 'termine').length;
            const enCours = teamData.filter(d => categorizeStatus(d.statut) === 'enCours').length;
            const aCadrer = teamData.filter(d => categorizeStatus(d.statut) === 'aCadrer').length;
            const aFaire = teamData.filter(d => categorizeStatus(d.statut) === 'aFaire').length;
            const nonDemarrees = aCadrer + aFaire;
            const totalTickets = teamData.reduce((sum, d) => sum + d.total, 0);
            const doneTickets = teamData.reduce((sum, d) => sum + d.done, 0);
            const pctTicketsDone = totalTickets > 0 ? (doneTickets / totalTickets) * 100 : 0;
            const pctEpicsTerminees = totalEpics > 0 ? (termine / totalEpics) * 100 : 0;
            const pctEpicsEnCours = totalEpics > 0 ? (enCours / totalEpics) * 100 : 0;
            const pctACadrer = totalEpics > 0 ? (aCadrer / totalEpics) * 100 : 0;
            const pctNonDemarrees = totalEpics > 0 ? (nonDemarrees / totalEpics) * 100 : 0;
            const pctEpicsActives = totalEpics > 0 ? ((termine + enCours) / totalEpics) * 100 : 0;
            return { totalEpics, termine, enCours, aCadrer, aFaire, nonDemarrees, totalTickets, doneTickets, pctTicketsDone, pctEpicsTerminees, pctEpicsEnCours, pctACadrer, pctNonDemarrees, pctEpicsActives };
        }

        function getTeamAlert(teamData) {
            const { pctEpicsTerminees, pctNonDemarrees, pctACadrer, pctEpicsEnCours, termine, totalEpics } = getTeamMetrics(teamData);
            if (totalEpics === 0) return 'none';
            if ((termine === 0 && pctEpicsEnCours > 80) || pctACadrer > 40) return 'red';
            if (pctEpicsTerminees < 10 || pctNonDemarrees > 40) return 'orange';
            return 'green';
        }

        function getEpicAttention(item) {
            const cat = categorizeStatus(item.statut);
            const pct = item.total > 0 ? (item.done / item.total) * 100 : 0;
            if (cat === 'enCours' && item.total > 0 && pct < 30) return { alert: true, color: 'red', reason: 'Demarree mais peu de progression' };
            if (cat === 'aCadrer' && item.total > 0) return { alert: true, color: 'orange', reason: 'Tickets crees mais cadrage non finalise' };
            if (cat === 'aFaire' && item.total > 0 && pct > 50) return { alert: true, color: 'orange', reason: 'Avancee mais toujours en backlog' };
            return { alert: false, color: 'none', reason: '' };
        }

        function getProgressBarColor(item) {
            const attention = getEpicAttention(item);
            if (attention.alert) return attention.color;
            const pct = item.total > 0 ? (item.done / item.total) * 100 : 0;
            if (pct > 60) return 'green';
            if (pct >= 30) return 'orange';
            return 'gray';
        }

        function getFilteredTeamData(team) {
            const filter = teamFilters[team] || 'build';
            let teamData = data.filter(d => d.equipe === team);
            if (filter === 'build') teamData = teamData.filter(d => d.type.toLowerCase() !== 'run');
            else if (filter === 'run') teamData = teamData.filter(d => d.type.toLowerCase() === 'run');
            return teamData;
        }

        function render() {
            infoBox.classList.remove('hidden');
            extractionInfo.textContent = `${data.length} Epics chargees pour ${teams.length} equipes — ${new Date().toLocaleDateString('fr-FR')}`;
            teams.forEach(t => teamFilters[t] = 'build');

            navTabs.classList.remove('hidden');
            navTabs.innerHTML = `
                <div class="nav-tab active" data-tab="global">Vue globale</div>
                <div class="nav-tab" data-tab="products">Par Produit</div>
                ${teams.map(team => {
                    const teamData = getFilteredTeamData(team);
                    const alert = getTeamAlert(teamData);
                    return `<div class="nav-tab" data-tab="${team}">${team}<span class="alert-badge ${alert}"></span></div>`;
                }).join('')}
            `;

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    showTab(tab.dataset.tab);
                });
            });

            renderContent();
            showTab('global');
        }

        function renderContent() {
            content.innerHTML = `
                <div class="team-section" id="tab-global">${renderGlobalView()}</div>
                <div class="team-section" id="tab-products">${renderProductsView()}</div>
                ${teams.map(team => `<div class="team-section" id="tab-${team}">${renderTeamView(team)}</div>`).join('')}
            `;
            attachFilterListeners();
        }

        function attachFilterListeners() {
            document.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const team = e.target.dataset.team;
                    teamFilters[team] = e.target.value;
                    document.getElementById(`tab-${team}`).innerHTML = renderTeamView(team);
                    attachFilterListeners();
                    updateTabBadge(team);
                });
            });
        }

        function updateTabBadge(team) {
            const teamData = getFilteredTeamData(team);
            const alert = getTeamAlert(teamData);
            const badge = document.querySelector(`.nav-tab[data-tab="${team}"] .alert-badge`);
            if (badge) badge.className = `alert-badge ${alert}`;
        }

        function renderGlobalView() {
            const globalStats = teams.map(team => {
                const teamData = getFilteredTeamData(team);
                const metrics = getTeamMetrics(teamData);
                const allData = data.filter(d => d.equipe === team);
                const runCount = allData.filter(d => d.type.toLowerCase() === 'run').length;
                return { team, ...metrics, alert: getTeamAlert(teamData), runCount };
            });

            return `
                <div class="info-box" style="margin-bottom: 1rem;">
                    <div class="info-box-content">Vue Build uniquement (hors Run). Le Run est du flux continu, non pertinent pour la completion mid-PI.</div>
                </div>
                <h3 style="margin-bottom: 1rem;">Vue consolidee par equipe</h3>
                <table class="global-table">
                    <thead><tr><th>Equipe</th><th>Epics</th><th>Terminees</th><th>En cours</th><th>Non demarrees</th><th>A cadrer</th><th>Alerte</th></tr></thead>
                    <tbody>
                        ${globalStats.map(s => `
                            <tr>
                                <td><strong>${s.team}</strong></td>
                                <td>${s.totalEpics} <span style="color: var(--text-secondary); font-size: 0.8rem;">(+${s.runCount} run)</span></td>
                                <td><strong style="color: var(--status-done);">${s.termine}</strong> <span style="color: var(--text-secondary); font-size: 0.8rem;">(${Math.round(s.pctEpicsTerminees)}%)</span></td>
                                <td>${s.enCours} <span style="color: var(--text-secondary); font-size: 0.8rem;">(${Math.round(s.pctEpicsEnCours)}%)</span></td>
                                <td>${s.nonDemarrees} <span style="color: var(--text-secondary); font-size: 0.8rem;">(${Math.round(s.pctNonDemarrees)}%)</span></td>
                                <td>${s.aCadrer > 0 ? `<span style="color: var(--indicator-orange);">${s.aCadrer}</span>` : '0'}</td>
                                <td><span class="indicator ${s.alert}"></span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderProductsView() {
            const productStats = {};
            data.forEach(d => {
                if (!d.composant) return;
                d.composant.split(',').map(c => c.trim()).forEach(comp => {
                    if (!productStats[comp]) productStats[comp] = { epics: [], teams: new Set() };
                    productStats[comp].epics.push(d);
                    productStats[comp].teams.add(d.equipe);
                });
            });

            const sortedProducts = Object.keys(productStats).sort();

            return `
                <h3 style="margin-bottom: 1rem;">Vue par Produit (cross-equipes)</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">Agregation par composant Jira.</p>
                <table class="global-table">
                    <thead><tr><th>Produit</th><th>Equipes</th><th>Epics</th><th>Terminees</th><th>En cours</th><th>Tickets Done</th><th>% Completion</th><th>Alerte</th></tr></thead>
                    <tbody>
                        ${sortedProducts.map(prod => {
                            const epics = productStats[prod].epics;
                            const teamsStr = [...productStats[prod].teams].join(', ');
                            const termine = epics.filter(d => categorizeStatus(d.statut) === 'termine').length;
                            const enCours = epics.filter(d => categorizeStatus(d.statut) === 'enCours').length;
                            const totalTickets = epics.reduce((sum, d) => sum + d.total, 0);
                            const doneTickets = epics.reduce((sum, d) => sum + d.done, 0);
                            const pct = totalTickets > 0 ? Math.round((doneTickets / totalTickets) * 100) : 0;
                            let alert = 'green';
                            if (pct < 30) alert = 'red';
                            else if (pct < 50) alert = 'orange';
                            return `<tr><td><strong>${prod}</strong></td><td style="font-size: 0.8rem; color: var(--text-secondary);">${teamsStr}</td><td>${epics.length}</td><td>${termine}</td><td>${enCours}</td><td>${doneTickets}/${totalTickets}</td><td>${pct}%</td><td><span class="indicator ${alert}"></span></td></tr>`;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderTeamView(team) {
            const currentFilter = teamFilters[team] || 'build';
            const teamData = getFilteredTeamData(team);
            const allTeamData = data.filter(d => d.equipe === team);
            const metrics = getTeamMetrics(teamData);
            const teamAlert = getTeamAlert(teamData);
            const runCount = allTeamData.filter(d => d.type.toLowerCase() === 'run').length;
            const buildCount = allTeamData.filter(d => d.type.toLowerCase() !== 'run').length;

            const sortedData = [...teamData].sort((a, b) => {
                const order = { 'enCours': 0, 'aCadrer': 1, 'aFaire': 2, 'termine': 3 };
                return (order[categorizeStatus(a.statut)] || 4) - (order[categorizeStatus(b.statut)] || 4);
            });

            return `
                <div class="team-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <div class="team-name">${team} <span class="indicator ${teamAlert}" style="display: inline-block; vertical-align: middle;"></span></div>
                            <div class="team-meta">Date d'extraction : ${new Date().toLocaleDateString('fr-FR')}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-size: 0.85rem; color: var(--text-secondary);">Afficher :</label>
                            <select class="filter-select" data-team="${team}" style="padding: 0.4rem 0.75rem; border-radius: 6px; border: 1px solid var(--border); font-size: 0.85rem; cursor: pointer;">
                                <option value="build" ${currentFilter === 'build' ? 'selected' : ''}>Build (${buildCount})</option>
                                <option value="run" ${currentFilter === 'run' ? 'selected' : ''}>Run (${runCount})</option>
                                <option value="all" ${currentFilter === 'all' ? 'selected' : ''}>Tout (${allTeamData.length})</option>
                            </select>
                        </div>
                    </div>
                    <div class="team-metrics">
                        <div class="team-metric"><span>Terminees :</span><span class="team-metric-value">${metrics.termine}/${metrics.totalEpics} (${Math.round(metrics.pctEpicsTerminees)}%)</span></div>
                        <div class="team-metric"><span>En cours :</span><span class="team-metric-value">${metrics.enCours} (${Math.round(metrics.pctEpicsEnCours)}%)</span></div>
                        <div class="team-metric"><span>Non demarrees :</span><span class="team-metric-value">${metrics.nonDemarrees} (${Math.round(metrics.pctNonDemarrees)}%)</span></div>
                        <div class="team-metric"><span>A cadrer :</span><span class="team-metric-value">${metrics.aCadrer}</span></div>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-card done"><div class="summary-card-value">${metrics.termine}</div><div class="summary-card-label">Termine</div></div>
                    <div class="summary-card progress"><div class="summary-card-value">${metrics.enCours}</div><div class="summary-card-label">En cours</div></div>
                    <div class="summary-card"><div class="summary-card-value">${metrics.aCadrer}</div><div class="summary-card-label">A cadrer</div></div>
                    <div class="summary-card"><div class="summary-card-value">${metrics.aFaire}</div><div class="summary-card-label">A faire</div></div>
                </div>

                <div class="epics-section">
                    <h3>Epics — Vue d'ensemble</h3>
                    <div class="epics-table">
                        <div class="epics-table-header"><div>Epic</div><div>Titre</div><div>Statut</div><div>Completion</div><div>Produit</div><div></div></div>
                        ${sortedData.map(d => {
                            const pct = d.total > 0 ? Math.round((d.done / d.total) * 100) : 0;
                            const attention = getEpicAttention(d);
                            const barColor = getProgressBarColor(d);
                            const typeClass = d.type.toLowerCase() === 'run' ? 'run' : (d.type.toLowerCase() === 'build' ? 'build' : '');
                            return `
                                <div class="epic-row ${attention.alert ? 'highlight' : ''}">
                                    <div class="epic-key">${d.epic}</div>
                                    <div class="epic-title">${d.titre}${d.type ? `<span class="type-badge ${typeClass}">${d.type}</span>` : ''}</div>
                                    <div><span class="status-badge ${getStatusClass(d.statut)}">${d.statut}</span></div>
                                    <div class="progress-cell">${d.total > 0 ? `<span class="progress-text">${d.done}/${d.total}</span><div class="progress-bar"><div class="progress-bar-fill ${barColor}" style="width: ${pct}%"></div></div>` : '<span class="progress-text">—</span>'}</div>
                                    <div class="composant-text" title="${d.composant}">${d.composant || '—'}</div>
                                    <div>${attention.alert ? `<span class="indicator ${attention.color}"></span>` : '<span class="indicator none"></span>'}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function showTab(tabId) {
            document.querySelectorAll('.team-section').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(`tab-${tabId}`);
            if (target) target.classList.add('active');
        }
    </script>
</body>
</html>
